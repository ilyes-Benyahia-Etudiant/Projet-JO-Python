<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Administration</title>
  <link rel="stylesheet" href="/static/css/index.css">
  <link rel="icon" href="/public/images/favicon.ico" type="image/x-icon">
</head>
<body>
  <div class="card">
    <div class="visual">
      <div class="visual-inner">
        <h1>Espace Administrateur</h1>
        <p class="lead">Cette page est réservée aux utilisateurs avec le rôle <strong>admin</strong>.</p>
        <div class="footer">
          <p>Connecté en tant que {{ email or 'admin' }}.</p>
        </div>
      </div>
    </div>
    <div class="form">
      <div class="group">
        <div class="label">Informations</div>
        <div id="admin-user" class="user-card">
          <div><strong>Email:</strong> {{ email or '' }}</div>
          <div><strong>Rôle:</strong> {{ role or '' }}</div>
        </div>
      </div>
      <div class="btn-group">
        <a href="/admin" class="btn">Rafraîchir</a>
        <a href="/admin/offres/new" class="btn">Ajouter une offre</a>
        <a href="/admin/scan" class="btn">Scanner un billet</a>
        <!-- formulaire de logout -->
        <form action="/auth/logout" method="post" style="display:inline;">
          <input type="hidden" name="X-CSRF-Token" value="{{ csrf_token or request.cookies.get('csrf_token', '') }}">
          <button type="submit" class="btn btn-warning">Déconnexion</button>
        </form>
      </div>
      {% if msg %}
        <div class="msg ok" style="display:block">{{ msg }}</div>
      {% endif %}
      <div class="group">
        <div class="label">Liste des offres</div>
        {% if offres %}
        <div class="table-wrap" style="overflow:auto;">
          <table class="table">
            <thead>
              <tr>
                <th>id</th>
                <th>title</th>
                <th>price</th>
                <th>category</th>
                <th>stock</th>
                <th>active</th>
                <th>created_at</th>
                <th>updated_at</th>
                <th>description</th>
                <th>image</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for row in offres %}
                <tr>
                  <td>{{ row['id'] }}</td>
                  <td>{{ row['title'] }}</td>
                  <td>{{ row['price'] }}</td>
                  <td>{{ row['category'] | default('') }}</td>
                  <td>{{ row['stock'] }}</td>
                  <td>{{ row['active'] }}</td>
                  <td>{{ row['created_at'] }}</td>
                  <td>{{ row['updated_at'] }}</td>
                  <td>{{ row['description'] | default('') }}</td>
                  <td>{{ row['image'] | default('') }}</td>
                  <td>
                    <a class="btn btn-secondary" href="/admin/offres/{{ row['id'] }}/edit">Modifier</a>
                    <!-- pour chaque offre -->
                    <form action="/admin/offres/{{ row['id'] }}/delete" method="post" style="display:inline;">
                      <input type="hidden" name="X-CSRF-Token" value="{{ csrf_token or request.cookies.get('csrf_token', '') }}">
                      <button class="btn btn-danger" type="submit">Supprimer</button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
          <div class="user-placeholder">Aucune offre disponible</div>
        {% endif %}
      </div>
      <!-- Nouvelle section: Commandes -->
      <div class="group">
        <div class="label">Commandes</div>
        {% if commandes %}
        <div class="table-wrap" style="overflow:auto;">
          <table class="table">
            <thead>
              <tr>
                <th>id</th>
                <th>utilisateur</th>
                <th>offre</th>
                <th>prix payé</th>
                <th>token</th>
                <th>créée le</th>
              </tr>
            </thead>
            <tbody>
              {% for c in commandes %}
              <tr>
                <td>{{ c['id'] }}</td>
                <td>
                  {% if c.get('users') %}
                    {{ c['users']['email'] }}
                  {% else %}
                    {{ c['user_id'] }}
                  {% endif %}
                </td>
                <td>
                  {% if c.get('offres') %}
                    {{ c['offres']['title'] }}
                  {% else %}
                    {{ c['offre_id'] }}
                  {% endif %}
                </td>
                <td>{{ c['price_paid'] }}</td>
                <td>{{ c['token'] }}</td>
                <td>{{ c['created_at'] }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
          <div class="user-placeholder">Aucune commande</div>
        {% endif %}
      </div>
    </div>
  </div>
  <script>
    // Même protection BFCache côté admin
    window.addEventListener('pageshow', function (e) {
      if (e.persisted) {
        window.location.reload();
      } else {
        try {
          var nav = performance.getEntriesByType && performance.getEntriesByType('navigation')[0];
          if (nav && nav.type === 'back_forward') {
            window.location.reload();
          }
        } catch (_) {}
      }
    });
  </script>
</body>
</html>