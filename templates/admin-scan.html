<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin - Scan Billet</title>
  <script src="https://cdn.tailwindcss.com  "></script>
  <!--<link rel="stylesheet" href="/static/css/index.css">
  <link rel="stylesheet" href="/static/css/styles.css">-->
  <link rel="icon" href="/public/images/favicon.ico" type="image/x-icon">
  <style>
    /* ========== RESET & BASE ========== */
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

/* ========== NAVBAR ========== */
.navbar {
  background: white;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
  padding: 1rem 2rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 100;
}

.navbar-left {
  display: flex;
  align-items: center;
  gap: 1rem;
}

/* Anneaux olympiques + titre */
.olympic-rings {
  display: flex;
  align-items: center;
  gap: 4px;
}

.ring {
  display: inline-block;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  border: 2px solid;
}

.blue { border-color: #0085C7; }
.yellow { border-color: #F4C300; }
.black { border-color: #000000; }
.green { border-color: #009F3D; }
.red { border-color: #DF0024; }

.navbar-title {
  font-size: 1.3rem;
  font-weight: 700;
  color: #DF0024;
  letter-spacing: 0.5px;
  margin-left: 8px;
}

/* Liens de navigation */
.navbar-links {
  display: flex;
  list-style: none;
  gap: 1.5rem;
  margin: 0;
  padding: 0;
}

.navbar-links a {
  text-decoration: none;
  color: #555;
  font-weight: 600;
  padding: 0.5rem 0.75rem;
  border-radius: 6px;
  transition: all 0.2s ease;
}

.navbar-links a:hover {
  background: #f0f4f8;
  color: #0085C7;
}

/* ========== FORM CONTROLS ========== */
.form-control {
  padding: 0.75rem 1rem;
  border: 2px solid #e1e5e9;
  border-radius: 8px;
  font-size: 1rem;
  transition: all 0.3s ease;
  background: #fafafa;
}

.form-control:focus {
  outline: none;
  border-color: #0085C7;
  background: white;
  box-shadow: 0 0 0 3px rgba(0, 133, 199, 0.1);
}

.btn-danger {
  background: #DF0024 !important; /* Rouge */
  color: white;
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
}

.btn-danger:hover {
  background: #9e001a !important;
}
/* ========== BUTTONS ========== */
.btn {
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.btn-primary {
  background: #0085C7; /* Bleu olympique */
  color: white;
}

.btn-primary:hover {
  background: #005f8e;
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0, 133, 199, 0.3);
}

.btn-success {
  background: #009F3D; /* Vert olympique */
  color: white;
}

.btn-success:hover {
  background: #006b2a;
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0, 159, 61, 0.3);
}

/* ========== RESPONSIVE ========== */
@media (max-width: 768px) {
  .navbar {
    flex-direction: column;
    gap: 1rem;
    padding: 1rem;
  }

  .navbar-links {
    margin-top: 1rem;
    justify-content: center;
    flex-wrap: wrap;
  }

  .form-control {
    min-width: 100% !important;
  }
}

@media (max-width: 480px) {
  .olympic-rings {
    gap: 2px;
  }

  .ring {
    width: 16px;
    height: 16px;
  }

  .navbar-title {
    font-size: 1.1rem;
  }
}

/* ========== CENTERED GROUP ========== */
.centered-group {
  max-width: 500px;
  margin: 2rem auto 0;
  padding: 0 1rem;
}

/* ========== LABEL ========== */
.label {
  font-size: 1.25rem;
  font-weight: 800;
  color: #000;
  margin: 1.5rem 0 0.75rem 0;
  padding-bottom: 0.4rem;
  border-bottom: 3px solid #DF0024; /* Rouge olympique */
  display: flex;
  justify-content: center;
  text-transform: uppercase;
  letter-spacing: 1px;
}

/* ========== USER CARD ========== */
#admin-user {
  background: linear-gradient(135deg, #f0f7ff, #e6f2ff); /* D√©grad√© bleu tr√®s doux */
  padding: 1.5rem;
  border-radius: 16px;
  border: 2px solid #0085C7; /* Bordure bleu olympique */
  box-shadow: 0 4px 12px rgba(0, 133, 199, 0.15);
  font-size: 1.05rem;
  text-align: center;
  transition: all 0.3s ease;
}

#admin-user:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 25px rgba(0, 133, 199, 0.25);
}

#admin-user strong {
  color: #0085C7; /* Bleu olympique pour les labels */
  font-weight: 700;
  display: inline-block;
  min-width: 80px;
}

#admin-user div {
  margin: 0.5rem 0;
  padding: 0.5rem;
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.6);
  backdrop-filter: blur(5px);
}

/* ========== OPTIONNEL : Ic√¥nes ou d√©coration ========== */
.label::before {
  content: "üèÖ ";
  margin-right: 8px;
}

#admin-user::before {
  content: "";
  display: block;
  width: 60px;
  height: 4px;
  background: linear-gradient(to right, #0085C7, #F4C300, #000000, #009F3D, #DF0024);
  margin: 0 auto 1rem;
  border-radius: 2px;
}


  </style>
</head>
<body class="bg-gray-50">
  <header>
    <nav class="navbar">
      <div class="navbar-left">
        <div class="olympic-rings">
          <span class="ring blue"></span>
          <span class="ring yellow"></span>
          <span class="ring black"></span>
          <span class="ring green"></span>
          <span class="ring red"></span>
          <span class="navbar-title">Admin Scan</span>
        </div>
      </div>
      <form action="/auth/logout" method="post" style="display:inline;">
          <input type="hidden" name="X-CSRF-Token" value="{{ csrf_token or request.cookies.get('csrf_token', '') }}">
          <button type="submit" class="btn-nav btn-danger">D√©connexion</button>
      </form>
    </nav>
  </header>

  <main class="container mx-auto p-6">
          <div class="group centered-group">
            <div class="label">Informations</div>
            <div id="admin-user" class="user-card">
              <div><strong>Email:</strong> {{ email or (user and user.get('email')) or '' }}</div>
              <div><strong>R√¥le:</strong> {{ role or (user and user.get('role')) or '' }}</div>
            </div>
          </div>
    <div id="scan-card" class="max-w-xl mx-auto bg-white shadow rounded p-6">
      <h2 class="text-2xl font-semibold mb-4">Scanner / Valider un billet</h2>
      <p class="text-gray-600 mb-4">
        Scannez un QR code qui contient une URL de type <code>/admin/scan?token=...</code> ou collez un token manuellement.
      </p>

      <!-- Formulaire de recherche (GET) -->
      <form id="token-form" method="get" action="/admin/scan" class="flex gap-2 items-center flex-wrap">
        <label for="token-input" class="font-semibold">Token</label>
        <input id="token-input" name="token" type="text" placeholder="Entrez le token du billet" class="form-control min-w-[280px]" value="{{ token or '' }}" />
        <button type="submit" class="btn btn-primary">Rechercher</button>
      </form>

      <!-- Contr√¥les Cam√©ra -->
      <div class="mt-4 flex gap-2">
        <button id="start-camera" type="button" class="btn btn-primary">Activer la cam√©ra</button>
        <button id="stop-camera" type="button" class="btn" style="display:none;">Arr√™ter</button>
      </div>
      <div id="camera-container" class="mt-2" style="display:none;">
        <video id="qr-video" playsinline style="width:100%; max-height: 280px; border-radius: 8px; background:#000;"></video>
        <canvas id="qr-canvas" style="display:none;"></canvas>
        <div id="scan-hint" class="text-gray-500 mt-1">Alignez le QR code dans le cadre.</div>
      </div>

      <!-- Bandeau de statut -->
      {% if status %}
        {% set statemap = {
            "Invalid":   {"label": "Invalide",        "css": "border-red-600 bg-red-100 text-red-600"},
            "Scanned":   {"label": "Pr√™t √† valider",  "css": "border-amber-600 bg-amber-100 text-amber-700"},
            "Validated": {"label": "Valid√©",          "css": "border-green-600 bg-emerald-100 text-green-700"},
            "AlreadyValidated": {"label": "D√©j√† valid√©", "css": "border-red-600 bg-red-100 text-red-600"}
          } %}
        <div class="mt-3 px-3 py-2 rounded-lg font-semibold border {{ statemap.get(status, {'label':'Inconnu','css':'border-gray-600 bg-gray-200 text-gray-700'}).css }}">
          {{ statemap.get(status, {'label':'Inconnu'}).label }}
        </div>
      {% endif %}

      <!-- D√©tails du billet -->
      {% if ticket %}
        <div class="mt-3 space-y-1">
          <div><strong>Token:</strong> {{ ticket.token }}</div>
          {% set title = ticket.title or (ticket.offre and ticket.offre.title) or (ticket.offre_title) %}
          {% if title %}<div><strong>D√©tails:</strong> {{ title }}</div>{% endif %}
          {% set email = ticket.userEmail or (ticket.users and ticket.users.email) or ticket.email %}
          {% if email %}<div><strong>Acheteur:</strong> {{ email }}</div>{% endif %}
          {% set created_at = ticket.created_at or ticket.createdAt %}
          {% if created_at %}<div><strong>Cr√©√© le:</strong> {{ created_at }}</div>{% endif %}
        </div>
      {% elif message %}
        <p class="mt-3">{{ message }}</p>
      {% endif %}

      <!-- Bouton Valider si pr√™t -->
      {% if status == "Scanned" and token %}
        <form method="post" action="/admin/scan/validate" class="mt-3">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          <input type="hidden" name="token" value="{{ token }}">
          <button type="submit" class="btn btn-success">Valider le billet</button>
        </form>
      {% endif %}
    </div>
  </main>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <script>
  (function() {
    const video = document.getElementById('qr-video');
    const canvas = document.getElementById('qr-canvas');
    const startBtn = document.getElementById('start-camera');
    const stopBtn = document.getElementById('stop-camera');
    const camContainer = document.getElementById('camera-container');
    const tokenInput = document.getElementById('token-input');
    let stream = null;
    let rafId = null;
    let lastToken = null;
    let lastScanTs = 0;

    function extractToken(text) {
      // Si le QR est une URL /admin/scan?token=..., on extrait le token; sinon on consid√®re le texte comme token
      try {
        const url = new URL(text, window.location.origin);
        const t = url.searchParams.get('token');
        if (t) return t;
      } catch (e) {}
      return text;
    }

    async function startCamera() {
      if (stream) return;
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { ideal: 'environment' } },
          audio: false
        });
        video.srcObject = stream;
        await video.play();
        camContainer.style.display = '';
        startBtn.style.display = 'none';
        stopBtn.style.display = '';
        scanLoop();
      } catch (err) {
        alert('Impossible d‚Äôacc√©der √† la cam√©ra: ' + err);
      }
    }

    function stopCamera() {
      if (rafId) cancelAnimationFrame(rafId);
      rafId = null;
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      video.srcObject = null;
      camContainer.style.display = 'none';
      startBtn.style.display = '';
      stopBtn.style.display = 'none';
    }

    function scanLoop() {
      if (!stream) return;
      const w = video.videoWidth, h = video.videoHeight;
      if (!w || !h) {
        rafId = requestAnimationFrame(scanLoop);
        return;
      }
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, w, h);
      const imageData = ctx.getImageData(0, 0, w, h);
      const qr = jsQR(imageData.data, w, h, { inversionAttempts: 'dontInvert' });
      const now = Date.now();
      if (qr && qr.data) {
        const token = extractToken(qr.data);
        if (token && (token !== lastToken || now - lastScanTs > 3000)) {
          lastToken = token;
          lastScanTs = now;
          if (tokenInput) tokenInput.value = token;
          handleSearchSubmit(new Event('submit', { cancelable: true }));
          if (navigator.vibrate) navigator.vibrate(100);
        }
      }
      rafId = requestAnimationFrame(scanLoop);
    }

    // Ajout: petit son de validation (bip court)
    function playSuccessBeep() {
      try {
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        if (!AudioCtx) return;
        const ctx = new AudioCtx();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = 'sine';
        osc.frequency.value = 880; // Fr√©quence du bip
        osc.connect(gain);
        gain.connect(ctx.destination);
        // mont√©e rapide puis d√©croissance
        gain.gain.setValueAtTime(0.0001, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.08, ctx.currentTime + 0.01);
        osc.start();
        setTimeout(() => {
          gain.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.15);
          osc.stop(ctx.currentTime + 0.16);
          ctx.close();
        }, 150);
      } catch (_) {
        // pas grave si le contexte audio n'est pas dispo
      }
    }

    async function fetchAndReplace(url, opts) {
      const res = await fetch(url, Object.assign({ credentials: 'same-origin' }, opts || {}));
      const html = await res.text();
      const doc = new DOMParser().parseFromString(html, 'text/html');
      const newCard = doc.getElementById('scan-card');
      const oldCard = document.getElementById('scan-card');
      if (newCard && oldCard) {
        oldCard.replaceWith(newCard);
        attachDynamicHandlers();
      }
      // Ajout: on retourne les √©l√©ments pour que l'appelant puisse d√©tecter l'√©tat
      return { newCard, doc };
    }

    function handleSearchSubmit(e) {
      e.preventDefault();
      const input = document.getElementById('token-input');
      const token = (input && input.value || '').trim();
      if (!token) return;
      const url = '/admin/scan?token=' + encodeURIComponent(token);
      fetchAndReplace(url, { method: 'GET', headers: { 'X-Requested-With': 'fetch' } });
    }

    function handleValidateSubmit(e) {
      e.preventDefault();
      const form = e.target;
      const fd = new FormData(form);
      const body = new URLSearchParams();
      for (const [k, v] of fd.entries()) body.append(k, v);
      fetchAndReplace('/admin/scan/validate', {
        method: 'POST',
        headers: {
          'X-Requested-With': 'fetch',
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body
      }).then((result) => {
        const input = document.getElementById('token-input');
        if (input) {
          input.value = '';
          input.focus();
        }
        lastToken = null; // autoriser le rescannage du m√™me billet apr√®s validation

        // Ajout: si le billet est "Valid√©", jouer un bip puis effacer l'affichage apr√®s 3s
        const card = (result && result.newCard) || document.getElementById('scan-card');
        const isValidated = !!(card && card.textContent && card.textContent.includes('Valid√©'));
        if (isValidated) {
          playSuccessBeep();
        }
        // Effacement automatique de l'affichage apr√®s 3s (retour √† l'√©tat initial sans ticket)
        setTimeout(() => {
          fetchAndReplace('/admin/scan', { method: 'GET', headers: { 'X-Requested-With': 'fetch' } });
        }, 3000);
      });
    }

    function attachDynamicHandlers() {
      // Re-bind du formulaire GET (recherche token)
      const tokenForm = document.querySelector('form[action="/admin/scan"][method="get"]');
      if (tokenForm) tokenForm.addEventListener('submit', handleSearchSubmit);

      // Re-bind du formulaire POST (validation)
      document.querySelectorAll('form[action="/admin/scan/validate"]').forEach(f => {
        f.addEventListener('submit', handleValidateSubmit);
      });

      // Focus sur le champ token pour un rescannage rapide
      const input = document.getElementById('token-input');
      if (input) input.focus();
    }

    // Bind initial
    attachDynamicHandlers();
    if (startBtn) startBtn.addEventListener('click', startCamera);
    if (stopBtn) stopBtn.addEventListener('click', stopCamera);
    window.addEventListener('beforeunload', stopCamera);
  })();
  </script>

  <!-- Scripts inutiles pour la version serveur: retir√©s -->
</body>
</html>