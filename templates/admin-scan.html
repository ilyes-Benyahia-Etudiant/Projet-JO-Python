<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin - Scan Billet</title>
  <script src="https://cdn.tailwindcss.com  "></script>
  <!--<link rel="stylesheet" href="/static/css/index.css">
  <link rel="stylesheet" href="/static/css/styles.css">-->
  <link rel="icon" href="/public/images/favicon.ico" type="image/x-icon">
  <style>
    /* ========== RESET & BASE ========== */
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

/* ========== NAVBAR ========== */
.navbar {
  background: white;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
  padding: 1rem 2rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 100;
}

.navbar-left {
  display: flex;
  align-items: center;
  gap: 1rem;
}

/* Anneaux olympiques + titre */
.olympic-rings {
  display: flex;
  align-items: center;
  gap: 4px;
}

.ring {
  display: inline-block;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  border: 2px solid;
}

.blue { border-color: #0085C7; }
.yellow { border-color: #F4C300; }
.black { border-color: #000000; }
.green { border-color: #009F3D; }
.red { border-color: #DF0024; }

.navbar-title {
  font-size: 1.3rem;
  font-weight: 700;
  color: #DF0024;
  letter-spacing: 0.5px;
  margin-left: 8px;
}

/* Liens de navigation */
.navbar-links {
  display: flex;
  list-style: none;
  gap: 1.5rem;
  margin: 0;
  padding: 0;
}

.navbar-links a {
  text-decoration: none;
  color: #555;
  font-weight: 600;
  padding: 0.5rem 0.75rem;
  border-radius: 6px;
  transition: all 0.2s ease;
}

.navbar-links a:hover {
  background: #f0f4f8;
  color: #0085C7;
}

/* ========== FORM CONTROLS ========== */
.form-control {
  padding: 0.75rem 1rem;
  border: 2px solid #e1e5e9;
  border-radius: 8px;
  font-size: 1rem;
  transition: all 0.3s ease;
  background: #fafafa;
}

.form-control:focus {
  outline: none;
  border-color: #0085C7;
  background: white;
  box-shadow: 0 0 0 3px rgba(0, 133, 199, 0.1);
}

.btn-danger {
  background: #DF0024 !important; /* Rouge */
  color: white;
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
}

.btn-danger:hover {
  background: #9e001a !important;
}
/* ========== BUTTONS ========== */
.btn {
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.btn-primary {
  background: #0085C7; /* Bleu olympique */
  color: white;
}

.btn-primary:hover {
  background: #005f8e;
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0, 133, 199, 0.3);
}

.btn-success {
  background: #009F3D; /* Vert olympique */
  color: white;
}

.btn-success:hover {
  background: #006b2a;
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0, 159, 61, 0.3);
}

/* ========== RESPONSIVE ========== */
@media (max-width: 768px) {
  .navbar {
    flex-direction: column;
    gap: 1rem;
    padding: 1rem;
  }

  .navbar-links {
    margin-top: 1rem;
    justify-content: center;
    flex-wrap: wrap;
  }

  .form-control {
    min-width: 100% !important;
  }
}

@media (max-width: 480px) {
  .olympic-rings {
    gap: 2px;
  }

  .ring {
    width: 16px;
    height: 16px;
  }

  .navbar-title {
    font-size: 1.1rem;
  }
}

/* ========== CENTERED GROUP ========== */
.centered-group {
  max-width: 500px;
  margin: 2rem auto 0;
  padding: 0 1rem;
}

/* ========== LABEL ========== */
.label {
  font-size: 1.25rem;
  font-weight: 800;
  color: #000;
  margin: 1.5rem 0 0.75rem 0;
  padding-bottom: 0.4rem;
  border-bottom: 3px solid #DF0024; /* Rouge olympique */
  display: flex;
  justify-content: center;
  text-transform: uppercase;
  letter-spacing: 1px;
}

/* ========== USER CARD ========== */
#admin-user {
  background: linear-gradient(135deg, #f0f7ff, #e6f2ff); /* D√©grad√© bleu tr√®s doux */
  padding: 1.5rem;
  border-radius: 16px;
  border: 2px solid #0085C7; /* Bordure bleu olympique */
  box-shadow: 0 4px 12px rgba(0, 133, 199, 0.15);
  font-size: 1.05rem;
  text-align: center;
  transition: all 0.3s ease;
}

#admin-user:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 25px rgba(0, 133, 199, 0.25);
}

#admin-user strong {
  color: #0085C7; /* Bleu olympique pour les labels */
  font-weight: 700;
  display: inline-block;
  min-width: 80px;
}

#admin-user div {
  margin: 0.5rem 0;
  padding: 0.5rem;
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.6);
  backdrop-filter: blur(5px);
}

/* ========== OPTIONNEL : Ic√¥nes ou d√©coration ========== */
.label::before {
  content: "üèÖ ";
  margin-right: 8px;
}

#admin-user::before {
  content: "";
  display: block;
  width: 60px;
  height: 4px;
  background: linear-gradient(to right, #0085C7, #F4C300, #000000, #009F3D, #DF0024);
  margin: 0 auto 1rem;
  border-radius: 2px;
}


  </style>
</head>
<body class="bg-gray-50">
  <header>
    <nav class="navbar">
      <div class="navbar-left">
        <div class="olympic-rings">
          <span class="ring blue"></span>
          <span class="ring yellow"></span>
          <span class="ring black"></span>
          <span class="ring green"></span>
          <span class="ring red"></span>
          <span class="navbar-title">Admin Scan</span>
        </div>
      </div>
      <form action="/auth/logout" method="post" style="display:inline;">
          <input type="hidden" name="X-CSRF-Token" value="{{ csrf_token or request.cookies.get('csrf_token', '') }}">
          <button type="submit" class="btn-nav btn-danger">D√©connexion</button>
      </form>
    </nav>
  </header>

  <main class="container mx-auto p-6">
          <div class="group centered-group">
            <div class="label">Informations</div>
            <div id="admin-user" class="user-card">
              <div><strong>Email:</strong> {{ email or (user and user.get('email')) or '' }}</div>
              <div><strong>R√¥le:</strong> {{ role or (user and user.get('role')) or '' }}</div>
            </div>
          </div>
    <div id="scan-card" class="max-w-xl mx-auto bg-white shadow rounded p-6">
      <h2 class="text-2xl font-semibold mb-4">Scanner / Valider un billet</h2>
      <p class="text-gray-600 mb-4">
        Scannez un QR code qui contient une URL de type <code>/admin/scan?token=...</code> ou collez un token manuellement.
      </p>

      <!-- Formulaire de recherche (GET) -->
      <form id="token-form" method="get" action="/admin/scan" class="flex gap-2 items-center flex-wrap">
        <label for="token-input" class="font-semibold">Token</label>
        <input id="token-input" name="token" type="text" placeholder="Entrez le token du billet" class="form-control min-w-[280px]" value="{{ token or '' }}" />
        <button type="submit" class="btn btn-primary">Rechercher</button>
      </form>

      <!-- Contr√¥les Cam√©ra -->
      <div class="mt-4 flex gap-2">
        <button id="start-camera" type="button" class="btn btn-primary">Activer la cam√©ra</button>
        <button id="stop-camera" type="button" class="btn" style="display:none;">Arr√™ter</button>
      </div>
      <div id="camera-container" class="mt-2" style="display:none;">
        <video id="qr-video" playsinline style="width:100%; max-height: 280px; border-radius: 8px; background:#000;"></video>
        <canvas id="qr-canvas" style="display:none;"></canvas>
        <div id="scan-hint" class="text-gray-500 mt-1">Alignez le QR code dans le cadre.</div>
      </div>

      <!-- Bloc de statut unifi√© et logique -->
      {% if status %}
        {% set statemap = {
            "Validated":        {"label": "Valid√©", "css": "border-green-600 bg-emerald-100 text-green-700"},
            "Scanned":          {"label": "Pr√™t √† valider", "css": "border-amber-600 bg-amber-100 text-amber-700"},
            "Error":            {"label": "Erreur", "css": "border-red-600 bg-red-100 text-red-600"},
            "AlreadyValidated": {"label": "D√©j√† valid√©", "css": "border-amber-600 bg-amber-100 text-amber-700"},
            "Invalid":          {"label": "Billet introuvable", "css": "border-red-600 bg-red-100 text-red-600"}
          }
        %}
        {% set status_info = statemap.get(status, statemap['Error']) %}

        <div id="scan-status-banner"
             data-status="{{ status }}"
             class="mt-3 px-3 py-2 rounded-lg font-semibold border {{ status_info.css }}">
          {{ message or status_info.label }}
        </div>
      {% endif %}

      <!-- D√©tails du billet -->
      {% if ticket %}
        {% set title = ticket.title or (ticket.offre and ticket.offre.title) or (ticket.offre_title) %}
        {% set email = ticket.userEmail or (ticket.users and ticket.users.email) or ticket.email %}
        {% set created_at = ticket.created_at or ticket.createdAt %}
        <div id="ticket-details" class="mt-3">
          {% if title %}<div><strong>D√©tails:</strong> {{ title }}</div>{% endif %}
          {% if email %}<div><strong>Acheteur:</strong> {{ email }}</div>{% endif %}
          {% if created_at %}<div><strong>Cr√©√© le:</strong> {{ created_at }}</div>{% endif %}
        </div>
      {% elif message %}
        <p class="mt-3">{{ message }}</p>
      {% endif %}

      <!-- Bouton Valider si pr√™t -->
      {% if status == "Scanned" and token %}
        <form id="validate-form" method="post" action="/admin/scan/validate" class="mt-3">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          <input type="hidden" name="token" value="{{ token }}">
          <button type="submit" class="btn btn-success">Valider le billet</button>
        </form>
      {% endif %}
    </div>
  </main>

  
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <script src="/public/js/app/admin-scan.js"></script>
</body>
</html>