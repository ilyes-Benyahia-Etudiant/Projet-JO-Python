<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin - Scan Billet</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/static/css/index.css">
  <link rel="stylesheet" href="/static/css/styles.css">
  <link rel="icon" href="/public/images/favicon.ico" type="image/x-icon">
</head>
<body class="bg-gray-50">
  <header>
    <nav class="navbar">
      <div class="navbar-left">
        <div class="olympic-rings">
          <span class="ring blue"></span>
          <span class="ring yellow"></span>
          <span class="ring black"></span>
          <span class="ring green"></span>
          <span class="ring red"></span>
          <span class="navbar-title">Admin Scan</span>
        </div>
      </div>
      <ul class="navbar-links" id="primary-navigation">
        <li><a href="/session">Ma Session</a></li>
        <li><a href="/admin/offres">Admin Offres</a></li>
      </ul>
    </nav>
  </header>

  <main class="container mx-auto p-6">
    <div class="max-w-xl mx-auto bg-white shadow rounded p-6">
      <h2 class="text-2xl font-semibold mb-4">Scanner / Valider un billet</h2>
      <p class="text-gray-600 mb-4">
        Scannez un QR code qui contient une URL de type <code>/admin/scan?token=...</code> ou collez un token manuellement.
      </p>

      <!-- Formulaire de recherche (GET) -->
      <form method="get" action="/admin/scan" class="flex gap-2 items-center flex-wrap">
        <label for="token-input" class="font-semibold">Token</label>
        <input id="token-input" name="token" type="text" placeholder="Entrez le token du billet" class="form-control min-w-[280px]" value="{{ token or '' }}" />
        <button type="submit" class="btn btn-primary">Rechercher</button>
      </form>

      <!-- Bandeau de statut -->
      {% if status %}
        {% set statemap = {
            "Invalid":   {"label": "Invalide",        "css": "border-red-600 bg-red-100 text-red-600"},
            "Scanned":   {"label": "Prêt à valider",  "css": "border-amber-600 bg-amber-100 text-amber-700"},
            "Validated": {"label": "Validé",          "css": "border-green-600 bg-emerald-100 text-green-700"},
            "AlreadyValidated": {"label": "Déjà validé", "css": "border-red-600 bg-red-100 text-red-600"}
          } %}
        {% set st = statemap.get(status, {"label":"Inconnu", "css":"border-gray-600 bg-gray-200 text-gray-700"}) %}
        <div class="mt-3 px-3 py-2 rounded-lg font-semibold border {{ st.css }}">
          {{ st.label }}
        </div>
      {% endif %}

      <!-- Détails du billet -->
      {% if ticket %}
        <div class="mt-3 space-y-1">
          <div><strong>Token:</strong> {{ ticket.token }}</div>
          {% set title = ticket.title or (ticket.offre and ticket.offre.title) or (ticket.offre_title) %}
          {% if title %}<div><strong>Détails:</strong> {{ title }}</div>{% endif %}
          {% set email = ticket.userEmail or (ticket.users and ticket.users.email) or ticket.email %}
          {% if email %}<div><strong>Acheteur:</strong> {{ email }}</div>{% endif %}
          {% set created_at = ticket.created_at or ticket.createdAt %}
          {% if created_at %}<div><strong>Créé le:</strong> {{ created_at }}</div>{% endif %}
        </div>
      {% elif message %}
        <p class="mt-3">{{ message }}</p>
      {% endif %}

      <!-- Bouton Valider si prêt -->
      {% if status == "Scanned" and token %}
        <form method="post" action="/admin/scan/validate" class="mt-3">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          <input type="hidden" name="token" value="{{ token }}">
          <button type="submit" class="btn btn-success">Valider le billet</button>
        </form>
      {% endif %}
    </div>
  </main>

  <!-- Scripts inutiles pour la version serveur: retirés -->
</body>
</html>