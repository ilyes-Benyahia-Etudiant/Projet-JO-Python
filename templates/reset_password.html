<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Réinitialiser le mot de passe</title>
  <link rel="stylesheet" href="/static/css/index.css">
  <link rel="icon" href="/public/images/favicon.ico" type="image/x-icon">
</head>
<body>
  <div class="card" style="max-width:560px;margin:32px auto">
    <h1>Réinitialiser le mot de passe</h1>
    {% if error %}<div class="msg err">{{ error }}</div>{% endif %}
    {% if message %}<div class="msg ok">{{ message }}</div>{% endif %}
    <form id="web-update-password-form" action="javascript:void(0);">
      <div class="group">
        <label>Nouveau mot de passe</label>
        <input class="input" name="new_password" type="password" minlength="6" required/>
      </div>
      <button class="btn" type="submit">Mettre à jour</button>
    </form>
  </div>
  <script src="/public/js/app/http.js"></script>
  <script src="/public/js/app/auth.js"></script>
  <script>
    (function () {
      function getTokenFromUrl() {
        // 1) query ?token=...
        const qs = new URLSearchParams(window.location.search);
        let token = qs.get('token');
        if (token) return token;

        // 2) fragment #access_token=... ou #token=...
        const hash = (window.location.hash || '').replace(/^#/, '');
        const hs = new URLSearchParams(hash);
        token = hs.get('access_token') || hs.get('token') || hs.get('code');
        return token || '';
      }

      function showMessage(type, text) {
        let el = document.querySelector('.msg.' + (type === 'error' ? 'err' : 'ok'));
        if (!el) {
          el = document.createElement('div');
          el.className = 'msg ' + (type === 'error' ? 'err' : 'ok');
          document.querySelector('.card')?.prepend(el);
        }
        el.textContent = text;
      }

      const form = document.getElementById('web-update-password-form');
      if (!form) return;

      form.addEventListener('submit', async function (e) {
        e.preventDefault();

        const newPasswordInput = form.querySelector('input[name="new_password"]');
        const new_password = newPasswordInput ? newPasswordInput.value : '';
        const token = getTokenFromUrl();

        if (!token) {
          showMessage('error', "Lien invalide: token manquant.");
          return;
        }
        if (!new_password) {
          showMessage('error', "Veuillez saisir un nouveau mot de passe.");
          return;
        }

        try {
          const res = await fetch("/api/v1/auth/update-password", {
            method: "POST",
            headers: { "Content-Type": "application/json", "Accept": "application/json" },
            body: JSON.stringify({ token, new_password })
          });

          const body = await res.json().catch(() => ({}));
          if (!res.ok) {
            const msg = body?.detail || body?.message || "Erreur lors de la mise à jour du mot de passe";
            showMessage('error', msg);
            return;
          }

          showMessage('ok', body?.message || "Mot de passe mis à jour");
          // Rediriger vers /auth après un court délai
          setTimeout(() => { window.location.assign("/auth?message=" + encodeURIComponent("Mot de passe mis à jour")); }, 500);
        } catch (err) {
          showMessage('error', "Erreur réseau. Veuillez réessayer.");
        }
      });
    })();
  </script>
</body>
</html>